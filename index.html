<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta content="utf-8" http-equiv="encoding">
    <title>UI for Yet Another Dapper</title>
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="https://code.jquery.com/jquery-2.2.0.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!-- Bootstrap -->
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

    <!-- Bootstrap Material Design -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.8/css/bootstrap-material-design.css">
    <link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/ripplejs/ripple/0.3.2/dist/ripple.js">

    <link href="jumbotron-narrow.css" rel="stylesheet">
  </head>
  <body>
    <div class="bs-component" id="top-nav-bar">
      <div class="navbar navbar-inverse">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-inverse">
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand">UI</a>
          </div>
          <div class="navbar-collapse collapse navbar-inverse navbar-right">
            <form class="navbar-form navbar-left" action="javascript:alert(this.nodeType);">
              <div class="form-group is-empty">
                <input type="search" class="form-control col-md-8" placeholder="Search" autofocus>
                <span class="material-input"></span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div class="jumbotron" id="view-area">
        <h1 id="trace-description">Jumbotron heading</h1>
        <div id="chartId"></div>
      </div>

      <footer class="footer">
        <p>&copy; 2016 Kostya Golikov</p>
      </footer>

    </div>
    <!-- /container -->

    <script type="text/javascript">
      const d3 = require("d3")

      const svg = d3.select("div#chartId")
        .append("div")
        .classed("svg-container", true) //container class to make it responsive
        .append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "0 0 600 400")
        .classed("svg-content-responsive", true);

      function draw_traces(trace_data) {
        const spans = trace_data.spans

        d3.select('#trace-description').text(trace_data.description)

        const rects = svg.selectAll('rect').data(spans);

        const newRects = rects.enter();

        const minTime = d3.min(spans, (x, i) => x.unix_timestamp);
        const maxTime = d3.max(spans, (x, i) => x.unix_timestamp + x.duration_ms);

        const minId = d3.min(spans, (x, i) => x.id);
        const maxId = d3.max(spans, (x, i) => x.id);

        const minDuration = d3.min(spans, (x, i) => x.duration_ms);
        const maxDuration = d3.max(spans, (x, i) => x.duration_ms);

        const xScale = d3.scale.log().domain([minTime, maxTime]).range([30, 300]);
        const widthScale = d3.scale.log().domain([minDuration, maxDuration]).range([1, 300]);

        const yScale = d3.scale.linear().domain([0, maxId]).range([0, 100]);

        newRects
          .append('rect')
          .attr("class", d => "rect")
          .attr('x', (d, i) => xScale(d.unix_timestamp))
          .attr('y', (d, i) => yScale(d.id))
          .attr('height', (d, i) => 40)
          .attr('width', (d, i) => widthScale(d.duration_ms))

        newRects
          .append('text')
          .attr('class', 'trace-description')
          .attr('x', (d, i) => xScale(d.unix_timestamp) + 10)
          .attr('y', (d, i) => yScale(d.id) + 35)
          .text((d, i) => d.description);
      }

      d3.json('http://private-909e2-dapper.apiary-mock.com/traces/1', (trace) => {
        console.log('got data: ', trace)
        draw_traces(trace[0])
      })
    </script>
  </body>
</html>
